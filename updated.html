<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Automated Timetable Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        color: #e2e8f0;
        overflow-x: hidden;
      }
      .glass-card {
        background: rgba(30, 41, 59, 0.5);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .form-input {
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(79, 70, 229, 0.2);
        color: #e2e8f0;
        outline: none;
        transition: all 0.3s ease;
      }
      .form-input:focus {
        border-color: rgba(79, 70, 229, 0.5);
        background: rgba(15, 23, 42, 0.9);
      }
      .form-input::placeholder {
        color: rgba(148, 163, 184, 0.6);
      }

      /* Hide scrollbar for webkit browsers */
      .hide-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .hide-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      /* Remove number input arrows */
      input[type="number"]::-webkit-outer-spin-button,
      input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }
      .btn-primary {
        background: linear-gradient(90deg, #4f46e5, #7c3aed);
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px 0 rgba(124, 58, 237, 0.3);
      }
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px 0 rgba(124, 58, 237, 0.4);
      }
      .btn-primary:disabled {
        background: #374151;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .btn-secondary {
        background-color: rgba(55, 65, 81, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
      }
      .btn-secondary:hover {
        background-color: rgba(75, 85, 99, 0.7);
      }
      .timetable-cell {
        min-height: 60px;
      }
      .subject-cell {
        background-color: rgba(79, 70, 229, 0.2);
        border: 1px solid rgba(79, 70, 229, 0.5);
      }
      .lab-cell {
        background-color: rgba(217, 70, 239, 0.2);
        border: 1px solid rgba(217, 70, 239, 0.5);
      }
      .sda-cell {
        background-color: rgba(16, 185, 129, 0.2);
        border: 1px solid rgba(16, 185, 129, 0.5);
      }
      .free-cell {
        background-color: rgba(100, 116, 139, 0.1);
        border: 1px solid rgba(100, 116, 139, 0.3);
      }
    </style>
  </head>
  <body
    class="min-h-screen w-full flex items-start justify-center p-4 sm:p-6 lg:p-8"
  >
    <div class="w-full max-w-6xl mx-auto space-y-8">
      <header class="text-center">
        <h1 class="text-4xl md:text-5xl font-bold text-white tracking-tight">
          Automated Timetable Generator
        </h1>
      </header>

      <!-- Step 1: Initial Counts -->
      <div id="step1" class="glass-card rounded-2xl p-6 md:p-8">
        <h2
          class="text-2xl font-semibold text-white mb-6 border-b border-gray-700 pb-3"
        >
          Step 1: Define Counts
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <label
              for="num_subjects"
              class="block text-sm font-medium text-indigo-200 mb-2"
              >Subjects</label
            >
            <input
              type="number"
              id="num_subjects"
              min="0"
              value="6"
              class="form-input w-full rounded-lg p-3"
            />
          </div>
          <div>
            <label
              for="num_labs"
              class="block text-sm font-medium text-indigo-200 mb-2"
              >Labs (Restricted Slots)</label
            >
            <input
              type="number"
              id="num_labs"
              min="0"
              value="3"
              class="form-input w-full rounded-lg p-3"
            />
          </div>
          <div>
            <label
              for="num_sdas"
              class="block text-sm font-medium text-indigo-200 mb-2"
              >SDAs (Flexible 2-Hour)</label
            >
            <input
              type="number"
              id="num_sdas"
              min="0"
              value="0"
              class="form-input w-full rounded-lg p-3"
            />
          </div>
        </div>
        <div class="mt-8 text-center">
          <button
            id="generate-forms-btn"
            class="btn-primary text-white font-semibold py-3 px-8 rounded-lg"
          >
            Proceed to Details
          </button>
        </div>
      </div>

      <!-- Step 2: Details Input -->
      <div id="step2" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-8">
          <div
            id="subject-details-card"
            class="glass-card rounded-2xl p-6 md:p-8 hidden"
          >
            <h2
              class="text-2xl font-semibold text-white mb-6 border-b border-gray-700 pb-3"
            >
              Subject Details
            </h2>
            <div
              id="subject-inputs-container"
              class="space-y-5 max-h-[22rem] overflow-y-auto hide-scrollbar pr-2"
            ></div>
          </div>
          <div
            id="lab-details-card"
            class="glass-card rounded-2xl p-6 md:p-8 hidden"
          >
            <h2
              class="text-2xl font-semibold text-white mb-6 border-b border-gray-700 pb-3"
            >
              Lab Details
            </h2>
            <div
              id="lab-inputs-container"
              class="space-y-5 max-h-[22rem] overflow-y-auto hide-scrollbar pr-2"
            ></div>
          </div>
          <div
            id="sda-details-card"
            class="glass-card rounded-2xl p-6 md:p-8 hidden"
          >
            <h2
              class="text-2xl font-semibold text-white mb-6 border-b border-gray-700 pb-3"
            >
              SDA Details
            </h2>
            <div
              id="sda-inputs-container"
              class="space-y-5 max-h-[22rem] overflow-y-auto hide-scrollbar pr-2"
            ></div>
          </div>
        </div>
        <div class="mt-8 text-center">
          <button
            id="generate-timetable-btn"
            class="btn-primary text-white font-bold py-4 px-10 rounded-lg text-lg"
          >
            Generate Timetable
          </button>
        </div>
      </div>

      <!-- Step 3: Output Display -->
      <div id="output-section" class="hidden space-y-8">
        <div id="timetable-output" class="glass-card rounded-2xl p-4 sm:p-6">
          <div
            class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4"
          >
            <h2 class="text-2xl font-semibold text-white">
              Generated Timetable
            </h2>
            <div class="flex gap-3">
              <button
                id="download-pdf-btn"
                class="btn-secondary text-white font-semibold py-2 px-5 rounded-lg flex items-center gap-2"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                  ></path>
                </svg>
                Download PDF
              </button>
              <button
                id="generate-again-btn"
                class="btn-secondary text-white font-semibold py-2 px-5 rounded-lg"
              >
                Generate Again
              </button>
            </div>
          </div>
          <div id="timetable-container" class="overflow-x-auto"></div>
        </div>
        <div id="verification-output" class="glass-card rounded-2xl p-6 md:p-8">
          <h2 class="text-2xl font-semibold text-white mb-4">
            Constraint Verification Report
          </h2>
          <div id="verification-list" class="space-y-3"></div>
        </div>
      </div>
    </div>

    <script>
      // --- UI Management ---
      const ui = {
        step1: document.getElementById("step1"),
        step2: document.getElementById("step2"),
        output: document.getElementById("output-section"),
        buttons: {
          generateForms: document.getElementById("generate-forms-btn"),
          generateTimetable: document.getElementById("generate-timetable-btn"),
          generateAgain: document.getElementById("generate-again-btn"),
          downloadPdf: document.getElementById("download-pdf-btn"),
        },
        cards: {
          subject: document.getElementById("subject-details-card"),
          lab: document.getElementById("lab-details-card"),
          sda: document.getElementById("sda-details-card"),
        },
        inputs: {
          subject: document.getElementById("subject-inputs-container"),
          lab: document.getElementById("lab-inputs-container"),
          sda: document.getElementById("sda-inputs-container"),
        },
        timetableContainer: document.getElementById("timetable-container"),
        verificationList: document.getElementById("verification-list"),
      };

      ui.buttons.generateForms.addEventListener("click", () => {
        const counts = {
          subject: parseInt(document.getElementById("num_subjects").value) || 0,
          lab: parseInt(document.getElementById("num_labs").value) || 0,
          sda: parseInt(document.getElementById("num_sdas").value) || 0,
        };
        if (Object.values(counts).every((c) => c <= 0)) return;
        createInputForms("subject", counts.subject);
        createInputForms("lab", counts.lab);
        createInputForms("sda", counts.sda);
        ui.step1.classList.add("hidden");
        ui.step2.classList.remove("hidden");
      });

      ui.buttons.generateTimetable.addEventListener("click", handleGeneration);
      ui.buttons.generateAgain.addEventListener("click", handleGeneration);
      ui.buttons.downloadPdf.addEventListener("click", downloadTimetablePDF);

      function createInputForms(type, count) {
        const container = ui.inputs[type];
        const card = ui.cards[type];
        container.innerHTML = "";
        if (count > 0) {
          for (let i = 1; i <= count; i++) {
            const div = document.createElement("div");
            if (type === "subject") {
              div.className =
                "grid grid-cols-1 sm:grid-cols-2 gap-4 items-center";
              div.innerHTML = `<input type="text" placeholder="Subject ${i} Name" class="form-input rounded-lg p-2 subject-code" data-type="subject"><input type="number" min="1" placeholder="Weekly Hours" class="form-input rounded-lg p-2 subject-hours">`;
            } else {
              div.innerHTML = `<input type="text" placeholder="${type.toUpperCase()} ${i} Name" class="form-input w-full rounded-lg p-2" data-type="${type}">`;
            }
            container.appendChild(div);
          }
          card.classList.remove("hidden");
        } else {
          card.classList.add("hidden");
        }
      }

      function renderTimetable(timetableData, config) {
        const timeSlots = config.timeSlots;
        const days = config.days;
        let tableHTML = `<table class="w-full text-center border-separate" style="border-spacing: 0 4px;"><thead><tr class="text-sm text-indigo-300"><th class="p-2 font-semibold">Day</th>`;
        timeSlots.forEach(
          (slot) => (tableHTML += `<th class="p-2 font-semibold">${slot}</th>`)
        );
        tableHTML += `</tr></thead><tbody>`;
        days.forEach((day, dayIndex) => {
          tableHTML += `<tr><td class="p-2 font-bold text-indigo-200">${day}</td>`;
          const rowData = timetableData[dayIndex] || [];
          rowData.forEach((cell) => {
            let cellClass = "free-cell";
            if (cell && cell !== "Free") {
              const subject = config.subjects[cell];
              if (subject && subject.isLab) cellClass = "lab-cell";
              else if (subject && subject.isSda) cellClass = "sda-cell";
              else cellClass = "subject-cell";
            }
            tableHTML += `<td class="timetable-cell p-2 rounded-md font-semibold ${cellClass}">${
              cell || "Free"
            }</td>`;
          });
          tableHTML += `</tr>`;
        });
        tableHTML += `</tbody></table>`;
        ui.timetableContainer.innerHTML = tableHTML;
      }

      function renderVerification(verificationData) {
        ui.verificationList.innerHTML = "";
        verificationData.forEach((item) => {
          const itemDiv = document.createElement("div");
          const statusClass = item.success ? "text-green-400" : "text-red-400";
          const statusIcon = item.success ? "✅" : "❌";
          itemDiv.className =
            "flex items-center p-3 rounded-lg bg-slate-800/50";
          itemDiv.innerHTML = `<span class="mr-3 text-lg">${statusIcon}</span><span class="font-semibold ${statusClass}">${
            item.success ? "PASS" : "FAIL"
          }</span><span class="ml-4 text-slate-300">${item.description}</span>`;
          ui.verificationList.appendChild(itemDiv);
        });
      }

      // --- Timetable Generator Logic ---

      class TimetableGenerator {
        constructor(config) {
          this.config = config;
          this.timetable = Array(config.days.length)
            .fill(null)
            .map(() => Array(config.timeSlots.length).fill(null));
        }

        shuffleArray(array) {
          for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
          }
          return array;
        }

        createClassQueue() {
          const queue = [];
          for (const code in this.config.subjects) {
            const subject = this.config.subjects[code];
            for (let i = 0; i < subject.hours; i++) queue.push(code);
          }
          return this.shuffleArray(queue);
        }

        canPlaceAt(subjectCode, day, slot) {
          const subject = this.config.subjects[subjectCode];
          const span = subject.isLab || subject.isSda ? 2 : 1;

          // Check if there's enough space for the span
          if (slot + span > this.config.timeSlots.length) return false;

          // Check if all slots in the span are free
          for (let i = 0; i < span; i++) {
            if (this.timetable[day][slot + i] !== null) return false;
          }

          // Check if subject already exists on this day
          if (this.timetable[day].includes(subjectCode)) return false;

          // Check lab/SDA constraints
          if (subject.isLab || subject.isSda) {
            // Only one lab/SDA per day
            for (let s = 0; s < this.config.timeSlots.length; s++) {
              const existingCell = this.timetable[day][s];
              if (
                existingCell &&
                this.config.subjects[existingCell] &&
                (this.config.subjects[existingCell].isLab ||
                  this.config.subjects[existingCell].isSda)
              ) {
                return false;
              }
            }
          }

          // Check valid starting slots for labs and SDAs
          if (subject.isLab && !this.config.validLabStartSlots.includes(slot))
            return false;
          if (subject.isSda && !this.config.validSdaStartSlots.includes(slot))
            return false;

          // Check 9 AM uniqueness constraint
          if (slot === 0) {
            for (let d = 0; d < this.config.days.length; d++) {
              if (d !== day && this.timetable[d][0] === subjectCode)
                return false;
            }
          }

          return true;
        }

        // Find the first available slot in a day (for gap-free scheduling)
        findFirstAvailableSlot(day, span) {
          for (let s = 0; s <= this.config.timeSlots.length - span; s++) {
            let canFit = true;
            for (let i = 0; i < span; i++) {
              if (this.timetable[day][s + i] !== null) {
                canFit = false;
                break;
              }
            }
            if (canFit) return s;
          }
          return -1; // No available slot
        }

        solve(classQueue) {
          if (classQueue.length === 0) return true;

          const subjectCode = classQueue[0];
          const remainingClasses = classQueue.slice(1);
          const subject = this.config.subjects[subjectCode];
          const span = subject.isLab || subject.isSda ? 2 : 1;

          // For gap-free scheduling, prioritize placing subjects in the first available slots
          const possiblePlacements = [];

          // If it's a lab or SDA, only consider valid starting slots
          if (subject.isLab || subject.isSda) {
            const validSlots = subject.isLab
              ? this.config.validLabStartSlots
              : this.config.validSdaStartSlots;
            for (let d = 0; d < this.config.days.length; d++) {
              for (const s of validSlots) {
                if (
                  s <= this.config.timeSlots.length - span &&
                  this.canPlaceAt(subjectCode, d, s)
                ) {
                  // For gap-free scheduling, prefer slots that fill from the beginning
                  const firstAvailable = this.findFirstAvailableSlot(d, span);
                  if (firstAvailable === s) {
                    possiblePlacements.push({ day: d, slot: s, priority: 1 });
                  } else {
                    possiblePlacements.push({ day: d, slot: s, priority: 2 });
                  }
                }
              }
            }
          } else {
            // Regular subjects - prioritize first available slots
            for (let d = 0; d < this.config.days.length; d++) {
              const firstAvailable = this.findFirstAvailableSlot(d, span);
              if (
                firstAvailable !== -1 &&
                this.canPlaceAt(subjectCode, d, firstAvailable)
              ) {
                possiblePlacements.push({
                  day: d,
                  slot: firstAvailable,
                  priority: 1,
                });
              }
            }
          }

          // Sort by priority (gap-free placements first), then by slot time
          possiblePlacements.sort((a, b) => {
            if (a.priority !== b.priority) return a.priority - b.priority;
            if (a.slot !== b.slot) return a.slot - b.slot;
            return Math.random() - 0.5; // Random order for same priority and slot
          });

          for (const { day, slot } of possiblePlacements) {
            // Place the subject
            for (let i = 0; i < span; i++) {
              this.timetable[day][slot + i] = subjectCode;
            }

            // Try to solve the rest
            if (this.solve(remainingClasses)) return true;

            // Backtrack
            for (let i = 0; i < span; i++) {
              this.timetable[day][slot + i] = null;
            }
          }
          return false;
        }

        generateTimetable() {
          // Reset timetable
          this.timetable = Array(this.config.days.length)
            .fill(null)
            .map(() => Array(this.config.timeSlots.length).fill(null));

          const classQueue = this.createClassQueue();
          const maxAttempts = 50;

          for (let attempt = 0; attempt < maxAttempts; attempt++) {
            // Reset and shuffle for each attempt
            this.timetable = Array(this.config.days.length)
              .fill(null)
              .map(() => Array(this.config.timeSlots.length).fill(null));
            this.shuffleArray(classQueue);

            if (this.solve([...classQueue])) {
              return this.createFinalTimetable();
            }
          }

          return null; // Failed to generate
        }

        createFinalTimetable() {
          // For each day, compact the schedule to remove gaps
          const compactedTimetable = this.timetable.map((row) => {
            const scheduledClasses = row.filter((cell) => cell !== null);
            const freeSlots =
              this.config.timeSlots.length - scheduledClasses.length;
            return [...scheduledClasses, ...Array(freeSlots).fill("Free")];
          });

          return compactedTimetable;
        }
      }

      // --- Main Handler ---
      function handleGeneration() {
        const btn = ui.buttons.generateTimetable;
        const againBtn = ui.buttons.generateAgain;

        btn.disabled = true;
        againBtn.disabled = true;
        btn.textContent = "Generating...";
        againBtn.textContent = "Generating...";

        const CONFIG = {
          subjects: {},
          timeSlots: [
            "09:00-10:00",
            "10:00-11:00",
            "11:20-12:20",
            "12:20-13:20",
            "14:00-15:00",
            "15:00-16:00",
          ],
          days: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
          validLabStartSlots: [2, 4], // 11:20-12:20 and 14:00-15:00
          validSdaStartSlots: [0, 2, 4], // 09:00-10:00, 11:20-12:20, and 14:00-15:00
        };

        // Collect subject inputs
        document
          .querySelectorAll('input[data-type="subject"]')
          .forEach((el, index) => {
            const code = el.value.trim();
            const hoursInput =
              document.querySelectorAll(".subject-hours")[index];
            const hours = hoursInput ? parseInt(hoursInput.value) : 0;
            if (code && hours > 0) {
              CONFIG.subjects[code] = {
                name: code,
                hours,
                isLab: false,
                isSda: false,
              };
            }
          });

        // Collect lab inputs
        document.querySelectorAll('input[data-type="lab"]').forEach((el) => {
          const code = el.value.trim();
          if (code) {
            CONFIG.subjects[code] = {
              name: code,
              hours: 1,
              isLab: true,
              isSda: false,
            };
          }
        });

        // Collect SDA inputs
        document.querySelectorAll('input[data-type="sda"]').forEach((el) => {
          const code = el.value.trim();
          if (code) {
            CONFIG.subjects[code] = {
              name: code,
              hours: 1,
              isLab: false,
              isSda: true,
            };
          }
        });

        setTimeout(() => {
          const generator = new TimetableGenerator(CONFIG);
          const finalTimetable = generator.generateTimetable();

          if (finalTimetable) {
            renderTimetable(finalTimetable, CONFIG);
            const verificationResults = verifyConstraints(
              finalTimetable,
              CONFIG
            );
            renderVerification(verificationResults);
            ui.step2.classList.add("hidden");
            ui.output.classList.remove("hidden");
          } else {
            alert(
              "Failed to generate a valid timetable. The combination of subjects, hours, and constraints might be impossible to solve. Please try adjusting your inputs."
            );
          }

          btn.disabled = false;
          againBtn.disabled = false;
          btn.textContent = "Generate Timetable";
          againBtn.textContent = "Generate Again";
        }, 50);
      }

      function verifyConstraints(timetable, config) {
        const results = [];
        const check = (description, success) =>
          results.push({ description, success });

        // 1. Check correct number of weekly hours
        const scheduledCounts = {};
        Object.keys(config.subjects).forEach(
          (code) => (scheduledCounts[code] = 0)
        );

        timetable.forEach((row) => {
          row.forEach((cell) => {
            if (
              cell &&
              cell !== "Free" &&
              scheduledCounts.hasOwnProperty(cell)
            ) {
              scheduledCounts[cell]++;
            }
          });
        });

        let hoursCorrect = true;
        for (const code in config.subjects) {
          const subject = config.subjects[code];
          const requiredHours =
            subject.hours * (subject.isLab || subject.isSda ? 2 : 1);
          const actualHours = scheduledCounts[code] || 0;
          if (actualHours !== requiredHours) {
            hoursCorrect = false;
            break;
          }
        }
        check(
          "All subjects have the correct number of weekly hours.",
          hoursCorrect
        );

        // 2. Check gap-free schedule
        let gapsCorrect = true;
        for (const row of timetable) {
          let foundFree = false;
          for (const cell of row) {
            if (cell === "Free") {
              foundFree = true;
            } else if (foundFree && cell !== "Free") {
              gapsCorrect = false;
              break;
            }
          }
          if (!gapsCorrect) break;
        }
        check(
          "Schedule is gap-free (all free slots are at the end of the day).",
          gapsCorrect
        );

        // 3. Check no subject repetition on same day
        let noDailyRepetition = true;
        for (const row of timetable) {
          const subjectCounts = {};
          row.forEach((cell) => {
            if (cell && cell !== "Free") {
              subjectCounts[cell] = (subjectCounts[cell] || 0) + 1;
            }
          });

          for (const code in subjectCounts) {
            const subject = config.subjects[code];
            if (!subject) continue;

            const maxAllowed = subject.isLab || subject.isSda ? 2 : 1;
            if (subjectCounts[code] > maxAllowed) {
              noDailyRepetition = false;
              break;
            }
          }
          if (!noDailyRepetition) break;
        }
        check(
          "No subject is scheduled more than once on the same day.",
          noDailyRepetition
        );

        // 4. Check maximum one lab/SDA per day
        let oneDoublePerDay = true;
        for (const row of timetable) {
          const labSdaCodes = new Set();
          row.forEach((cell) => {
            if (
              cell &&
              cell !== "Free" &&
              config.subjects[cell] &&
              (config.subjects[cell].isLab || config.subjects[cell].isSda)
            ) {
              labSdaCodes.add(cell);
            }
          });
          if (labSdaCodes.size > 1) {
            oneDoublePerDay = false;
            break;
          }
        }
        check(
          "A maximum of one lab/SDA is scheduled per day.",
          oneDoublePerDay
        );

        // 5. Check 9 AM class uniqueness
        const nineAmClasses = [];
        timetable.forEach((row) => {
          if (row[0] && row[0] !== "Free") {
            nineAmClasses.push(row[0]);
          }
        });
        const uniqueNineAm =
          new Set(nineAmClasses).size === nineAmClasses.length;
        check(
          "The 9 AM class is unique for each day it is scheduled.",
          uniqueNineAm
        );

        // 6. Check valid lab/SDA placement
        let validBlockPlacement = true;
        for (let d = 0; d < timetable.length; d++) {
          for (let s = 0; s < timetable[d].length; s++) {
            const cell = timetable[d][s];
            if (cell && cell !== "Free" && config.subjects[cell]) {
              const subject = config.subjects[cell];

              // Check if this is the start of a lab/SDA block
              const isBlockStart = s === 0 || timetable[d][s - 1] !== cell;

              if (isBlockStart) {
                if (subject.isLab && !config.validLabStartSlots.includes(s)) {
                  validBlockPlacement = false;
                  break;
                }
                if (subject.isSda && !config.validSdaStartSlots.includes(s)) {
                  validBlockPlacement = false;
                  break;
                }
              }
            }
          }
          if (!validBlockPlacement) break;
        }
        check(
          "Labs and SDAs are placed in valid starting slots.",
          validBlockPlacement
        );

        return results;
      }

      // PDF Download functionality
      async function downloadTimetablePDF() {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF("l", "mm", "a4"); // Landscape orientation for better table fit

        // Add title
        pdf.setFontSize(18);
        pdf.setTextColor(79, 70, 229);
        pdf.text("Automated Timetable Generator", 20, 20);

        pdf.setFontSize(10);
        pdf.setTextColor(0, 0, 0);
        pdf.text("Generated on: " + new Date().toLocaleDateString(), 20, 30);

        // Get timetable data
        const timetable = getCurrentTimetableData();
        if (!timetable) {
          alert("No timetable data available");
          return;
        }

        // Table configuration
        const startY = 45;
        const cellWidth = 40;
        const cellHeight = 15;
        const headerHeight = 12;

        // Draw table headers
        pdf.setFontSize(9);
        pdf.setFont("helvetica", "bold");

        // Time slot headers
        const timeSlots = [
          "Day",
          "09:00-10:00",
          "10:00-11:00",
          "11:20-12:20",
          "12:20-13:20",
          "14:00-15:00",
          "15:00-16:00",
        ];
        timeSlots.forEach((slot, index) => {
          const x = 20 + index * cellWidth;
          pdf.rect(x, startY, cellWidth, headerHeight);
          pdf.text(slot, x + 2, startY + 8);
        });

        // Draw table body
        pdf.setFont("helvetica", "normal");
        const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];

        days.forEach((day, dayIndex) => {
          const y = startY + headerHeight + dayIndex * cellHeight;

          // Day column
          pdf.rect(20, y, cellWidth, cellHeight);
          pdf.setFont("helvetica", "bold");
          pdf.text(day, 22, y + 10);

          // Time slot columns
          pdf.setFont("helvetica", "normal");
          for (let slotIndex = 0; slotIndex < 6; slotIndex++) {
            const x = 20 + (slotIndex + 1) * cellWidth;
            pdf.rect(x, y, cellWidth, cellHeight);

            const cellContent =
              timetable[dayIndex] && timetable[dayIndex][slotIndex]
                ? timetable[dayIndex][slotIndex]
                : "Free";

            // Add text with proper wrapping
            const textLines = pdf.splitTextToSize(cellContent, cellWidth - 4);
            let textY = y + 8;

            textLines.forEach((line, lineIndex) => {
              if (lineIndex < 2) {
                // Limit to 2 lines per cell
                pdf.text(line, x + 2, textY);
                textY += 4;
              }
            });
          }
        });

        // Add legend
        const legendY = startY + headerHeight + days.length * cellHeight + 20;
        pdf.setFontSize(10);
        pdf.setFont("helvetica", "bold");
        pdf.text("Legend:", 20, legendY);

        pdf.setFont("helvetica", "normal");
        pdf.setFontSize(9);
        pdf.text(
          "• Regular subjects appear as single periods",
          20,
          legendY + 8
        );
        pdf.text(
          "• Labs and SDAs span 2 hours (consecutive periods)",
          20,
          legendY + 15
        );
        pdf.text(
          "• Free periods indicate no scheduled classes",
          20,
          legendY + 22
        );

        // Save the PDF
        pdf.save("timetable.pdf");
      }

      // Helper function to get current timetable data
      function getCurrentTimetableData() {
        const table = document.querySelector("#timetable-container table");
        if (!table) return null;

        const rows = table.querySelectorAll("tbody tr");
        const timetableData = [];

        rows.forEach((row) => {
          const cells = row.querySelectorAll("td");
          const dayData = [];
          // Skip first cell (day name) and get time slot data
          for (let i = 1; i < cells.length; i++) {
            dayData.push(cells[i].textContent.trim());
          }
          timetableData.push(dayData);
        });

        return timetableData;
      }
    </script>
  </body>
</html>
